{% extends "base.html" %} {% block title %}Calculadora de Física{% endblock %}
{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0" id="titulo-calculadora">Calculadora de Física</h4>
        </div>
        <div class="card-body">
          <form id="form-calculadora" onsubmit="return calcular(event)">
            <input type="hidden" id="tipo-calculo" name="tipo_calculo" />

            <!-- Área para exibir a descrição do cálculo -->
            <div
              id="calculation-description"
              class="alert alert-info d-none mb-3"
            ></div>

            <!-- Campos dinâmicos serão inseridos aqui -->
            <div id="campos-variaveis"></div>

            <!-- Botão para identificar variável a ser calculada -->
            <div
              id="variavel-a-calcular-info"
              class="alert alert-warning mt-3 d-none"
            >
              <i class="fas fa-question-circle me-2"></i>Calcule:
              <span id="variavel-calculada-nome"></span>
            </div>

            <div class="mt-4">
              <button type="submit" class="btn btn-success me-2">
                Calcular
              </button>
              <button
                type="reset"
                class="btn btn-danger"
                onclick="limparResultado()"
              >
                Limpar
              </button>
            </div>
          </form>

          <div
            id="resultado"
            class="alert alert-success mt-4"
            style="display: none"
          ></div>
          <div
            id="erro"
            class="alert alert-danger mt-4"
            style="display: none"
          ></div>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card shadow">
        <div class="card-header bg-secondary text-white">
          <h5 class="mb-0">Categorias de Cálculo</h5>
        </div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            {% for category_key, category in
            config.CALCULATORS['fisica']['categories'].items() %}
            <li class="list-group-item bg-light p-0">
              <a
                class="nav-link py-2 px-3 text-primary"
                data-bs-toggle="collapse"
                href="#collapse{{ loop.index }}"
                role="button"
                aria-expanded="false"
                aria-controls="collapse{{ loop.index }}"
              >
                {{ category.title }}
              </a>
              <div class="collapse" id="collapse{{ loop.index }}">
                <ul class="list-group list-group-flush">
                  {% for calc_id, calc_info in category.calculations.items() %}
                  <li class="list-group-item bg-light border-top p-0">
                    <a
                      href="#"
                      class="list-group-item list-group-item-action d-flex justify-content-between align-items-center text-dark"
                      data-calculation="{{ calc_id }}"
                      data-description="{{ calc_info.description }}"
                    >
                      {{ calc_info.title }}
                    </a>
                  </li>
                  {% endfor %}
                </ul>
              </div>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}
<script>
  // Objeto de configuração das calculadoras (para JavaScript)
  const CALCULATORS_CONFIG = {{ config.CALCULATORS | tojson }};

  // Função para formatar o nome da variável
  function formatarVariavel(variavel) {
    return variavel.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
  }

  // Função para atualizar os campos de variáveis e exibir descrição
  function atualizarVariaveis(tipo, description) {
      const camposDiv = document.getElementById('campos-variaveis');
      camposDiv.innerHTML = '';

      const calculationDescriptionDiv = document.getElementById('calculation-description');
      if (description) {
          calculationDescriptionDiv.textContent = description;
          calculationDescriptionDiv.classList.remove('d-none');
      } else {
          calculationDescriptionDiv.textContent = '';
          calculationDescriptionDiv.classList.add('d-none');
      }

      // Encontra o cálculo nas categorias
      let calcInfo = null;
      for (const categoryKey in CALCULATORS_CONFIG.fisica.categories) {
          if (CALCULATORS_CONFIG.fisica.categories[categoryKey].calculations[tipo]) {
              calcInfo = CALCULATORS_CONFIG.fisica.categories[categoryKey].calculations[tipo];
              break;
          }
      }

      if (!calcInfo) return;

      // Atualiza o título e o tipo de cálculo
      document.getElementById('titulo-calculadora').textContent = calcInfo.title;
      document.getElementById('tipo-calculo').value = tipo;

      // Cria a seção de seleção de variáveis com checkboxes
      const variablesContainer = document.createElement('div');
      variablesContainer.className = 'card mt-3 mb-3';
      variablesContainer.innerHTML = `
          <div class="card-header bg-secondary text-white">
              <h6 class="mb-0">Selecione as Variáveis que você tem:</h6>
          </div>
          <div class="card-body">
              <div class="row" id="checkboxes-container"></div>
              <div id="inputs-container"></div>
          </div>
      `;
      camposDiv.appendChild(variablesContainer);

      const checkboxesContainer = document.getElementById('checkboxes-container');
      const inputsContainer = document.getElementById('inputs-container');

      calcInfo.variables.forEach(function (v) {
          const colDiv = document.createElement('div');
          colDiv.className = 'col-md-6 mb-2';
          colDiv.innerHTML = `
              <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="${v}" id="check_${v}">
                  <label class="form-check-label" for="check_${v}">
                      ${formatarVariavel(v)}
                  </label>
              </div>
          `;
          checkboxesContainer.appendChild(colDiv);

          // Adiciona listener para o checkbox
          const checkbox = document.getElementById(`check_${v}`);
          checkbox.addEventListener('change', function() {
              toggleVariableInput(v, calcInfo.variables.length);
          });
      });

      // Esconde a info de calcular ao mudar o cálculo
      document.getElementById('variavel-a-calcular-info').classList.add('d-none');
      document.getElementById('erro').style.display = 'none';
  }

  // Função para adicionar/remover campo de input e gerenciar a variável a calcular
  function toggleVariableInput(variableName, totalVariables) {
      const inputId = `input_${variableName}`;
      let inputDiv = document.getElementById(inputId);
      const inputsContainer = document.getElementById('inputs-container');
      const allCheckboxes = document.querySelectorAll('#checkboxes-container input[type="checkbox"]');
      const checkedCount = document.querySelectorAll('#checkboxes-container input[type="checkbox"]:checked').length;
      const calculateInfoDiv = document.getElementById('variavel-a-calcular-info');
      const calculateVariableNameSpan = document.getElementById('variavel-calculada-nome');

      if (event.target.checked) {
          if (!inputDiv) { // Se o input não existe, cria
              inputDiv = document.createElement('div');
              inputDiv.className = 'mb-3';
              inputDiv.id = inputId;
              inputDiv.innerHTML = `
                  <label for="${variableName}" class="form-label">${formatarVariavel(variableName)}</label>
                  <input type="number" step="any" class="form-control" id="${variableName}" name="${variableName}" required>
              `;
              inputsContainer.appendChild(inputDiv);
          }
      } else {
          if (inputDiv) { // Se o input existe, remove
              inputDiv.remove();
          }
      }

      // Lógica para determinar a variável a calcular
      if (checkedCount === totalVariables - 1) {
          let missingVariable = null;
          let selectedVariables = [];
          allCheckboxes.forEach(cb => {
              if (cb.checked) {
                  selectedVariables.push(cb.value);
              }
          });

          const currentCalcInfo = getCurrentCalculationInfo(); // Obtém info do cálculo atual
          if (currentCalcInfo) {
              missingVariable = currentCalcInfo.variables.find(v => !selectedVariables.includes(v));
          }

          if (missingVariable) {
              calculateVariableNameSpan.textContent = formatarVariavel(missingVariable);
              calculateInfoDiv.classList.remove('d-none');
              // Torna todos os campos de input não requeridos, exceto os selecionados
              document.querySelectorAll('#inputs-container input').forEach(input => {
                  input.required = selectedVariables.includes(input.name);
              });
          } else {
              calculateInfoDiv.classList.add('d-none');
          }
      } else {
          calculateInfoDiv.classList.add('d-none');
          // Se o número de checkboxes marcados não é n-1, todos os inputs criados são requeridos
          document.querySelectorAll('#inputs-container input').forEach(input => {
              input.required = true;
          });
      }

      // Limita a seleção a n-1 variáveis
      if (checkedCount > totalVariables -1) {
          event.target.checked = false; // Desmarca o último checkbox clicado
          if (inputDiv) inputDiv.remove(); // Remove o input se ele foi criado
          calculateInfoDiv.classList.add('d-none');
          alert('Você só pode selecionar ' + (totalVariables - 1) + ' variáveis para calcular a que falta.');
      } else if (checkedCount === totalVariables) {
          alert('Você já selecionou todas as variáveis. Limpe o formulário para começar de novo.');
          event.target.checked = false;
          if (inputDiv) inputDiv.remove();
      }
  }

  // Função auxiliar para obter info do cálculo atual
  function getCurrentCalculationInfo() {
      const tipo = document.getElementById('tipo-calculo').value;
      if (!tipo) return null;
      for (const categoryKey in CALCULATORS_CONFIG.fisica.categories) {
          if (CALCULATORS_CONFIG.fisica.categories[categoryKey].calculations[tipo]) {
              return CALCULATORS_CONFIG.fisica.categories[categoryKey].calculations[tipo];
          }
      }
      return null;
  }

  // Função para calcular
  async function calcular(event) {
    event.preventDefault(); // Impede o envio do formulário padrão

    const tipoCalculo = document.getElementById('tipo-calculo').value;
    const formFields = document.querySelectorAll('#inputs-container input'); // Pega inputs do container
    const data = { tipo_calculo: tipoCalculo };
    let hasEmptyField = false;

    formFields.forEach((field) => {
      if (field.required && field.value === '') {
        hasEmptyField = true;
      }
      data[field.name] = parseFloat(field.value);
    });

    if (hasEmptyField) {
      document.getElementById('erro').textContent = 'Por favor, preencha todas as variáveis selecionadas.';
      document.getElementById('erro').style.display = 'block';
      document.getElementById('resultado').style.display = 'none';
      return;
    }

    // Identifica a variável a ser calculada (aquela que não foi fornecida)
    const currentCalcInfo = getCurrentCalculationInfo();
    const providedVariables = Object.keys(data).filter(key => key !== 'tipo_calculo');
    let variableToCalculate = null;

    if (currentCalcInfo && providedVariables.length === currentCalcInfo.variables.length - 1) {
        variableToCalculate = currentCalcInfo.variables.find(v => !providedVariables.includes(v));
        if (variableToCalculate) {
            data[variableToCalculate] = null; // Envia como null para o backend calcular
        }
    } else {
        // Se a quantidade de variáveis não for n-1, o backend vai precisar de todos os valores preenchidos.
        // Ou o usuário pode ter clicado "Calcular" sem selecionar a quantidade correta.
        document.getElementById('erro').textContent = 'Por favor, selecione N-1 variáveis para que o cálculo possa ser feito. Ou forneça todos os N valores para verificar.';
        document.getElementById('erro').style.display = 'block';
        document.getElementById('resultado').style.display = 'none';
        return;
    }


    try {
      const response = await fetch('/fisica', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (response.ok) {
        let resultText = 'Resultado: ';
        // Adiciona a unidade ao resultado
        for (const key in result.resultado) {
            resultText += `${formatarVariavel(key)} = ${result.resultado[key]}`;
        }
        document.getElementById('resultado').textContent = resultText;
        document.getElementById('resultado').style.display = 'block';
        document.getElementById('erro').style.display = 'none';
      } else {
        document.getElementById('erro').textContent =
          'Erro: ' + (result.error || 'Ocorreu um erro.');
        document.getElementById('erro').style.display = 'block';
        document.getElementById('resultado').style.display = 'none';
      }
    } catch (error) {
      document.getElementById('erro').textContent =
        'Erro ao processar cálculo: ' + error;
      document.getElementById('erro').style.display = 'block';
      document.getElementById('resultado').style.display = 'none';
    }
  }

  // Função para limpar o resultado
  function limparResultado() {
    document.getElementById('resultado').style.display = 'none';
    document.getElementById('erro').style.display = 'none';
    document.getElementById('form-calculadora').reset();
    document.getElementById('campos-variaveis').innerHTML = ''; // Limpa os campos dinâmicos
    document.getElementById('calculation-description').classList.add('d-none'); // Esconde a descrição
    document.getElementById('variavel-a-calcular-info').classList.add('d-none'); // Esconde a info de calcular
  }

  // Adicionar o event listener para os links de cálculo
  document.querySelectorAll('a[data-calculation]').forEach(link => {
      link.addEventListener('click', function(e) {
          e.preventDefault();
          const tipo = this.dataset.calculation;
          const description = this.dataset.description; // Pega a descrição do atributo data-description
          atualizarVariaveis(tipo, description); // Passa a descrição para a função
          document.getElementById('resultado').style.display = 'none'; // Esconde resultado anterior
          document.getElementById('erro').style.display = 'none'; // Esconde erro anterior
      });
  });
</script>

<style>
  .list-group-item.text-dark:hover {
    background-color: #0d6efd !important; /* Cor azul forte */
    color: white !important; /* Texto branco no hover */
  }
  .list-group-item.text-dark {
    transition: background-color 0.3s ease, color 0.3s ease;
    color: #212529 !important; /* Cor padrão para itens não selecionados */
  }
  /* Estilo para as categorias que já estão abertas */
  .list-group-item.bg-light .nav-link.text-primary {
    color: #0d6efd !important; /* Cor azul forte para categorias */
  }
  .list-group-item.bg-light .nav-link.text-primary:hover {
    background-color: rgba(13, 110, 253, 0.1); /* Um azul mais claro no hover */
  }
  /* Remover borda do top se necessário */
  .list-group-flush > .list-group-item {
    border-width: 0 0 1px !important;
  }
  .list-group-flush > .list-group-item:last-child {
    border-bottom-width: 0 !important;
  }
</style>
{% endblock %}
