{% extends "base.html" %} {% block title %}Calculadora de Química{% endblock %}
{% block content %}
<div class="container py-5">
  <!-- Hero Section -->
  <div class="text-center mb-5">
    <h1 class="display-4 fw-bold text-primary">Calculadora de Química</h1>
    <p class="lead text-muted">Calcule massas, mols e reações em segundos</p>
  </div>

  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0" id="titulo-calculadora">Calculadora de Química</h4>
        </div>
        <div class="card-body">
          <form id="form-calculadora" onsubmit="return calcular(event)">
            <input type="hidden" id="tipo-calculo" name="tipo_calculo" />

            <!-- Área para exibir a descrição do cálculo -->
            <div
              id="calculation-description"
              class="alert alert-info d-none mb-3"
            ></div>

            <!-- Campos dinâmicos serão inseridos aqui -->
            <div id="campos-variaveis"></div>

            <div class="mt-4">
              <button type="submit" class="btn btn-success me-2">
                Calcular
              </button>
              <button
                type="reset"
                class="btn btn-danger"
                onclick="limparResultado()"
              >
                Limpar
              </button>
            </div>
          </form>

          <div
            id="resultado"
            class="alert alert-success mt-4"
            style="display: none"
          ></div>
          <div
            id="erro"
            class="alert alert-danger mt-4"
            style="display: none"
          ></div>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card shadow">
        <div class="card-header bg-secondary text-white">
          <h5 class="mb-0">Categorias de Cálculo</h5>
        </div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            {% for category_key, category in
            config.CALCULATORS['quimica']['categories'].items() %}
            <li class="list-group-item bg-light p-0">
              <a
                class="nav-link py-2 px-3 text-primary"
                data-bs-toggle="collapse"
                href="#collapse{{ loop.index }}"
                role="button"
                aria-expanded="false"
                aria-controls="collapse{{ loop.index }}"
              >
                {{ category.title }}
              </a>
              <div class="collapse" id="collapse{{ loop.index }}">
                <ul class="list-group list-group-flush">
                  {% for calc_id, calc_info in category.calculations.items() %}
                  <li class="list-group-item bg-light border-top p-0">
                    <a
                      href="#"
                      class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                      data-calculation="{{ calc_id }}"
                      data-description="{{ calc_info.description }}"
                    >
                      {{ calc_info.title }}
                    </a>
                  </li>
                  {% endfor %}
                </ul>
              </div>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}
<script>
  // Objeto de configuração das calculadoras (para JavaScript)
  const CALCULATORS_CONFIG = {{ config.CALCULATORS | tojson }};

  // Função para formatar o nome da variável
  function formatarVariavel(variavel) {
    return variavel.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
  }

  // Função para atualizar os campos de variáveis e exibir descrição
  function atualizarVariaveis(tipo, description) {
      const camposDiv = document.getElementById('campos-variaveis');
      camposDiv.innerHTML = '';

      const calculationDescriptionDiv = document.getElementById('calculation-description');
      if (description) {
          calculationDescriptionDiv.textContent = description;
          calculationDescriptionDiv.classList.remove('d-none');
      } else {
          calculationDescriptionDiv.textContent = '';
          calculationDescriptionDiv.classList.add('d-none');
      }

      // Encontra o cálculo nas categorias
      let calcInfo = null;
      for (const categoryKey in CALCULATORS_CONFIG.quimica.categories) {
          if (CALCULATORS_CONFIG.quimica.categories[categoryKey].calculations[tipo]) {
              calcInfo = CALCULATORS_CONFIG.quimica.categories[categoryKey].calculations[tipo];
              break;
          }
      }

      if (!calcInfo) return;

      // Atualiza o título e o tipo de cálculo
      document.getElementById('titulo-calculadora').textContent = calcInfo.title;
      document.getElementById('tipo-calculo').value = tipo;

      // Chamar o script para criar os campos
      const variaveis = calcInfo.variables;
      variaveis.forEach(function (v) {
          const formGroup = document.createElement('div');
          formGroup.className = 'mb-3';
          formGroup.innerHTML = `
              <label for="${v}" class="form-label">${formatarVariavel(v)}</label>
              <input type="number" step="any" class="form-control" id="${v}" name="${v}" required>
          `;
          camposDiv.appendChild(formGroup);
      });

      document.getElementById('erro').style.display = 'none';
  }

  // Função para calcular
  async function calcular(event) {
    event.preventDefault(); // Impede o envio do formulário padrão

    const tipoCalculo = document.getElementById('tipo-calculo').value;
    const formFields = document.querySelectorAll('#campos-variaveis input');
    const data = { tipo_calculo: tipoCalculo };

    formFields.forEach((field) => {
      data[field.name] = parseFloat(field.value);
    });

    try {
      const response = await fetch('/quimica', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (response.ok) {
        document.getElementById('resultado').textContent =
          'Resultado: ' + JSON.stringify(result);
        document.getElementById('resultado').style.display = 'block';
        document.getElementById('erro').style.display = 'none';
      } else {
        document.getElementById('erro').textContent =
          'Erro: ' + (result.error || 'Ocorreu um erro.');
        document.getElementById('erro').style.display = 'block';
        document.getElementById('resultado').style.display = 'none';
      }
    } catch (error) {
      document.getElementById('erro').textContent =
        'Erro ao processar cálculo: ' + error;
      document.getElementById('erro').style.display = 'block';
      document.getElementById('resultado').style.display = 'none';
    }
  }

  // Função para limpar o resultado
  function limparResultado() {
    document.getElementById('resultado').style.display = 'none';
    document.getElementById('erro').style.display = 'none';
    document.getElementById('form-calculadora').reset();
  }

  // Adicionar o event listener para os links de cálculo
  document.querySelectorAll('a[data-calculation]').forEach(link => {
      link.addEventListener('click', function(e) {
          e.preventDefault();
          const tipo = this.dataset.calculation;
          const description = this.dataset.description; // Pega a descrição do atributo data-description
          atualizarVariaveis(tipo, description); // Passa a descrição para a função
          document.getElementById('resultado').style.display = 'none'; // Esconde resultado anterior
          document.getElementById('erro').style.display = 'none'; // Esconde erro anterior
      });
  });
</script>
{% endblock %}
